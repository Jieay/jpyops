{% extends 'base.html' %}
{% load mytags %}
{% block content %}
{% include 'nav_cat_bar.html' %}

<div class="wrapper wrapper-content animated fadeInRight">
   <div class="row">
   <div class="col-sm-6">
	    <div class="row">
	        <div class="col-sm-12">
	            <div class="ibox float-e-margins">
	                <div class="ibox-title">
	                    <h5>创建部署任务</h5>
	                    <div class="ibox-tools">
	                        <a class="collapse-link">
	                            <i class="fa fa-chevron-up"></i>
	                        </a>
	                    </div>	                    
	                </div>
	                <div class="ibox-content">
	                    <form id="cmdForm" method="post" class="form-horizontal">
	
	                        <div class="form-group">
                                <label class="col-sm-2 control-label">主机IP<span class="red-fonts"> *</span> </label>
                                <div class=" col-sm-10 col-lg-10 ">
                                    <input type="text" id="id_hostip" value="" name="hostip" class="form-control">
                                </div>                                            
                            </div>
	                        <div class="hr-line-dashed"></div>
	                        
							<div class="form-group">
                                <label class="col-sm-2 control-label">执行类型<span class="red-fonts"> *</span> </label>
                                <div class=" col-sm-10 col-lg-10 " id="cmdradio">
                                	<label><input name="Fruit" type="radio" checked="checked" value="cmd.run" />Shell命令</label>
                                	<label><input name="Fruit" type="radio" value="state.sls" />salt模块 </label>
                                    <!--  
                                    <input type="text" id="id_furits" value="" name="furits" class="form-control">
                                    -->
                                </div>                                            
                            </div>
	                        <div class="hr-line-dashed"></div>
                            
                            <div class="form-group">
                                <label class="col-sm-2 control-label">命令参数<span class="red-fonts"> *</span> </label>
                                <div class=" col-sm-10 col-lg-10 ">
                                    <input type="text" id="parm_arg" value="" name="parm_arg" class="form-control">
                                </div>                                            
                            </div>
	
	                        <div class="hr-line-dashed"></div>
	                        <div class="form-group">
	                            <div class="col-sm-4 col-sm-offset-5">
	                                <button class="btn btn-white" type="reset"> 重置 </button>
	                                <button class="btn btn-primary" type="button" id="cmdsubmit"> 提交 </button>
	                            </div>
	                        </div>
	                    </form>
	                </div>
	            </div>
	        </div>
	    </div>
	
	
	    <div class="row">
	        <div class="col-sm-12">
	            <div class="ibox float-e-margins">
	                <div class="ibox-title">
	                    <h5>部署任务清单</h5>
	                    <div class="ibox-tools">
	                        <a class="collapse-link">
	                            <i class="fa fa-chevron-up"></i>
	                        </a>
	                    </div>
	                </div>
	                <div class="ibox-content">
	                    <div class="">
		                    <form id="execute_form" method="get" action="" class="pull-left mail-search">
		                    	<input type="button" id="execute_check" class="btn btn-danger btn-sm"  name="del_button" value="执行所选"/>
		
		                    </form>
	                    </div>
	
	                    <form id="contents_form" name="contents_form">
	                    <table class="table table-striped table-bordered table-hover " id="editable" >
	                        <thead>
	                            <tr>
	                                {% ifequal 2 2 %}
	                                    <th class="text-center"><input id="checkall" type="checkbox" class="i-checks" name="checkall" value="checkall" data-editable='false' onclick="check_all('contents_form')"></th>
	                                {% endifequal %}
	                                <th class="text-center"> 主机 </th>
	                                <th class="text-center"> 方案 </th>
	                                <th class="text-center"> 操作 </th>
	                            </tr>
	                        </thead>
	                        <tbody>
	                        {% for post in contacts.object_list  %}
	                            <tr class="gradeX">
	                                <td class="text-center" name="j_id" value="{{ post.id }}" data-editable='false'><input name="id" value="{{ post.id }}" type="checkbox" class="i-checks"></td>
	                                <td class="text-center"> 192.168.1.11 </td>
	                                <td class="text-center"> 111 </td>
	                                <td class="text-center">
	
	                                    <a href="{% url 'area_edit' %}?id={{ post.id }}" class="btn btn-xs btn-info">编辑</a>
	                                    <a value="{% url 'area_del' %}?id={{ post.id }}" class="btn btn-xs btn-danger area_del">删除</a>
	                                </td>
	                            </tr>
	                        {% endfor %}
	                        </tbody>
	                    </table>
	                   <div class="row">
	                        <div class="col-sm-6">
	                            <div class="dataTables_info" id="editable_info" role="status" aria-live="polite">
	                                Showing {{ contacts.start_index }} to {{ contacts.end_index }} of {{ p.count }} entries
	                            </div>
	                        </div>
	                        {% include 'paginator.html' %}
	                    </div>
	                   </form>
	                </div>
	            </div>
	        </div>
	    </div>
	    <div class="row">
	        <div class="col-sm-12">
	            <div class="ibox float-e-margins">
	                <div class="ibox-title">
	                    <h5>部署任务进度</h5>
	                    <div class="ibox-tools">
	                        <a class="collapse-link">
	                            <i class="fa fa-chevron-up"></i>
	                        </a>
	                    </div>	                    
	                </div>
	                <div class="ibox-content">
	                    <h1 class="no-margins"><a href="{% url 'user_list' %}">{{ users.count}}</a></h1>
	                    <small>All user</small>
	                </div>
	            </div>
	        </div>
	    </div>    
	    </div>

          <div class="col-sm-6 ">
              <div class="ibox float-e-margins">
                  <div class="ibox-title">
                      <h5>部署详细信息</h5>
                      <div class="ibox-tools">
                          <a class="collapse-link">
                              <i class="fa fa-chevron-up"></i>
                          </a>
                      </div>
                  </div>
                  <div class="ibox-content ibox-heading">
	                  <div id="cmdht"style="background-color: #000000; color:#7FFF00;font-size:12px;height: 600px; width:100%; overflow :auto">
		                  <div id="cmd_div" style="position: relative; margin-top: 10px; margin-right: 10px;  margin-bottom: 10px; margin-left: 10px;">
			                  <p id="cmd_detail_host" style="font-family: "Monaco", "Microsoft Yahei", "DejaVu Sans Mono", "Liberation Mono"; ">部署主机</p>  
			                  <p id="cmd_detail_msg" style="font-family: "Monaco", "Microsoft Yahei", "DejaVu Sans Mono", "Liberation Mono"; ">部署信息</p> 
		                  </div>

	                  </div>
                  	  <br>
                      <small><i class="fa fa-map-marker"></i> 统计共执行了多少主机</small>
                  </div>
              </div>
          </div>
     
	 </div>
</div>
{% endblock %}

{% block self_footer_js %}
<script>	
        
        $('#cmdsubmit').click(function(){
	        var hostip = $("#id_hostip").val();
	        var furits = $('#cmdradio input:checked').val();
	        var parm_arg = $("#parm_arg").val();
	        $('#cmd_detail_host').text('');
	        $('#cmd_detail_msg').text('');
	        //$('#cmd_div').append(hostip)       
	        $.ajax({
	        	url: '{% url "dispose_add" %}',
	        	data: {'hostip':hostip, 'furits':furits,'parm_arg':parm_arg},
	        	type: "POST",
	        	success: function(callbak){
	        		console.log(callbak);
	        		if (callbak.status == 1){
		        		//$("#id_hostip").val('');
		        		//$("#id_furits").val('');
		        		console.log(callbak.data[0]);
		        		
		        		        		
	        		}
	        	}
	        });
	        
        
        });
		
		window.tags = 'True'		
        function cmdhistory(){
        	if (window.tags == 'True'){
		        $.ajax({
		        	url: '{% url "dispose_history" %}',
		        	type: "POST",
		        	data: '',
		        	success: function(callbak){
		        		//console.log(callbak);
		        		//var callbak = jQuery.parseJSON(callbak);
		        		if (callbak.status == 1){
			        		//console.log(callbak.data)
			        		window.ht_id = callbak.data[0].id
			        		console.log(window.ht_id)
			        		//console.log(typeof(callbak.data))
			        		/*
		        			var data = callbak.data.reverse()
		        			$(data).each(function(k,v){
		        				console.log(v)
		        				var jid = v.jid
		        				var serverid = v.ids
		        				var result = v.returns
		        				var status = v.success
			        			var textdata1 = 'jid:' + jid + ' ' + 'id:' + serverid + ' ' + 'status:' + status
			        			var textdata2 = '返回值:'+ '<br>' + result
			        			var xsp1 = '<p style="font-size:14px; color:#FF34B3;font-family: "Monaco", "Microsoft Yahei", "DejaVu Sans Mono", "Liberation Mono";"> '+textdata1+' </p>'
			        			var xsp2 = '<p> '+textdata2+' </p>'
			        			$("#cmd_div").append(xsp1);
			        			$("#cmd_div").append(xsp2);
			        			$('#cmdht').scrollTop($('#cmd_div').height());				        				


			        			var fruitdata = v.fruits
			        			console.log(fruitdata)
			        			var fruitdata = jQuery.parseJSON(fruitdata);
			        			console.log(typeof(fruitdata))
			        			console.log(fruitdata[0])
			        			for (var i in fruitdata[0]){
				        			var textdata1 = i
				        			var textdata2 = fruitdata[0][i]
				        			var xsp1 = '<p style="font-size:14px; color:#FF34B3;font-family: "Monaco", "Microsoft Yahei", "DejaVu Sans Mono", "Liberation Mono";"> '+textdata1+' </p>'
				        			var xsp2 = '<p> '+textdata2+' </p>'
				        			//$("#cmd_div").append(xsp1);
				        			//$("#cmd_div").append(xsp2);
				        			//$('#cmdht').scrollTop($('#cmd_div').height());

			        			}


		        			
		        			});			        		
			        		*/
			        		
			        		window.tags = 'False'		        		
		        		}else{
		        		
		        		}
		        	}
		        });         	
        	
        	}else{
        		//console.log(window.ht_id)
		        $.ajax({
		        	url: '{% url "dispose_news" %}',
		        	type: "POST",
		        	data: {'ht_id':window.ht_id},
		        	success: function(callbak){
		        		//console.log(callbak);
		        		//var callbak = jQuery.parseJSON(callbak);
		        		if (callbak.status == 1){
		        			//console.log(callbak.data)
		        			//console.log(typeof(callbak.data))
		        			//console.log(callbak.data[0])
		        			//console.log(typeof(callbak.data[0]))
		        			if (window.data_id != callbak.data[0].id){
		        				window.data_id = callbak.data[0].id
		        				var hsidata = callbak.data.reverse()
		        				//console.log(hsidata[0])
		        				$(hsidata).each(function(k,v){
				        			
			        				var jid = v.jid
			        				var serverid = v.ids
			        				var result = v.returns
			        				var status = v.success
			        				console.log(result)
			        				console.log(typeof(result))
				        			var textdata1 = 'jid:' + jid + '&nbsp;&nbsp;' + '主机:' + serverid + '&nbsp;&nbsp;' + '状态:' + status
				        			var textdata2 = '返回值:'+ '<br>' + result
				        			var xsp1 = '<p style="font-size:14px; color:#FF34B3;font-family: "Monaco", "Microsoft Yahei", "DejaVu Sans Mono", "Liberation Mono";"> '+textdata1+' </p>'
				        			var xsp2 = '<p> '+textdata2+' </p>'
				        			$("#cmd_div").append(xsp1);
				        			$("#cmd_div").append(xsp2);
				        			$('#cmdht').scrollTop($('#cmd_div').height());			        				
				        			
				        			/*
				        			var fruitdata = v.fruits
				        			var fruitdata = jQuery.parseJSON(fruitdata);	        				
				        			for (var i in fruitdata[0]){
					        			var textdata1 = i
					        			var textdata2 = fruitdata[0][i]
					        			var xsp1 = '<p style="font-size:14px; color:#FF34B3;font-family: "Monaco", "Microsoft Yahei", "DejaVu Sans Mono", "Liberation Mono";"> '+textdata1+' </p>'
					        			var xsp2 = '<p> '+textdata2+' </p>'
					        			$("#cmd_div").append(xsp1);
					        			$("#cmd_div").append(xsp2);
					        			$('#cmdht').scrollTop($('#cmd_div').height());
	
				        			}	
				        			*/	        				
		        				});
		        			
		        			}else{
		        				console.log('meiyougengxin')
		        			
		        			}

		        			
		        		}else{
		        		
		        		}	
		        	}
		        }); 
		              	
        	}
        };

		setInterval('cmdhistory()',1000);

</script>
{% endblock %}